Con l'intruduzione nelle API delle funzioni di Geocoding, il servizio di mapp online di Google e' diventato ancora piu' semplice da utilizzare: una vera manna per i programmatori!<br/><br/>In questo articolo illustro brevemente un metodo estremamente semplice (e grezzo) per caricare in maniera asincrona una serie di marker sulla mappa, utilizzando javascript e un piccolo script ASP, richiamando i dati da un database.<br/><br/>Per prima cosa, richiediamo a google una Api Key per utilizzare il servizio: <a href="http://www.google.com/apis/maps/signup.html" target="_blank">http://www.google.com/apis/maps/signup.html</a> (io ne ho richiesta una per il sito http://127.0.0.1, in modo da poter sviluppare comodamente in ambiente di test) e includere nella pagina il riferimento alle Google Api:<br/><blockquote><code>&lt;script src="http://maps.google.com/maps?<br/>file=api&amp;v=2&amp;key=KEY_GENERATA"<br/>type="text/javascript"&gt;<br/>&lt;/script&gt;</code></blockquote><br/>Prossimo passo e' richiamare le funzioni necessarie alla creazione della mappa, quindi creiamo subito sulla nostra pagina un &lt;DIV&gt; destinato a contenerla<br/><blockquote>&lt;div id="mappa" style="width: 500px; height: 300px"&gt;&lt;/div&gt;</blockquote><br/>e un file .js contenente le funzioni a noi necessarie che includeremo nella pagina.<br/><br/>La prima funzione da realizzare sara' giustamente quella destinata alla creazione della mappa:<br/><blockquote><br/><p align="left">var map;</p><br/><p align="left">&nbsp;</p><br/><br/><p align="left">function map_create(elemento) {<br/>map=new GMap2(document.getElementById(elemento));<br/>map.setCenter(new GLatLng(41.895466,12.482323),10,G_NORMAL_MAP);<br/>map.addControl(new GMapTypeControl());<br/>map.addControl(new GLargeMapControl());<br/>mapmade=true;<br/>}</p></blockquote><br/>...dove <em>elemento</em> sara' l'ID del &lt;DIV&gt; creato precedentemente. (la mappa viene automaticamente centrata sulla citta' di Roma con  la funzione <em>setCenter</em>).<br/><br/>Ora scriviamo un piccola funzione che ci permettera' di creare comodamente markers sulla mappa partendo direttamente da un indirizzo, calcolando autonomamente le coordinate di geomapping:<br/><blockquote>function AddMarkerFromAddress(address, fumetto, titolo) {<br/><br/>var geocoder = new GClientGeocoder();<br/>geocoder.getLatLng(address,<br/>function(point) {<br/>if (!point) {<br/>alert(address + " not found");<br/>} else {<br/>var marker = new GMarker(point);<br/>GEvent.addListener(marker, "click", function() {<br/>marker.openInfoWindowHtml(fumetto);<br/>});<br/>map.addOverlay(marker);<br/>}<br/>}<br/>);<br/><br/>}</blockquote><br/>(dove <em>address</em> contiene l'indirizzo al quale creare il marker, <em>fumetto</em> il testo, anche HTML, contenuto appunto nel fumetto e <em>titolo</em> l'eventuale titolo del fumetto).<br/><br/>A questo punto non ci rimane che prelevare la lista degli indirizzi dal database e richiamare <em>n </em>volte la funzione <em>AddMarkerFromAddress</em>.<br/><br/>Inanzitutto realizziamo una pagina ASP che accetti in ingresso una query e restituisca una lista dei dati ottenuti eseguendo la query stessa:<br/><blockquote>&lt;%<br/><br/>response.addHeader "Pragma", "no-cache"<br/>response.addHeader "Cache-Control", "must-revalidate"<br/>response.addHeader "Cache-Control", "no-cache"<br/>response.addHeader "Cache-Control", "no-store"<br/>Response.AddHeader "Expires", 0<br/><br/>set con = Server.CreateObject ("ADODB.connection")<br/>Con.Open Application("Connessione_Database")<br/><br/>sql = request("query")<br/>set rs = con.Execute(sql)<br/><br/>risultato = ""<br/><br/>do until rs.eof<br/><br/>for i = 0 to rs.Fields.Count - 1<br/><br/>Response.Write rs(i)<br/>if (i &lt; rs.Fields.Count - 1) then Response.Write ", "<br/><br/>next<br/><br/>Response.Write VbLf<br/><br/>rs.movenext<br/>loop<br/>%&gt;</blockquote><br/>E' necessaria in seguito  del codice Js che si occupi di caricare i dati dalla pagina:<br/><blockquote>function GetSQLList(query) {<br/>var xmlhttp = getXMLHttpRequestInstance();<br/>if(!xmlhttp) {<br/>alert("Il browser non supporta l'oggetto XMLHttpRequest");<br/>return false;<br/>}<br/>var ReturnValue = "0";<br/><br/>query = escape(query);<br/><br/>xmlhttp.open("GET", "make_query_list.asp?query="+query,false);<br/>xmlhttp.send(null);<br/>if (xmlhttp.status==200) {<br/>ReturnValue = xmlhttp.responseText;<br/>} else if (xmlhttp.status==404) {<br/>alert("[ERRORE] l'URL non esiste!");<br/>} else {<br/>alert("[ERRORE] errore non gestito (" + xmlhttp.status + ")");<br/>}<br/>return ReturnValue;<br/>}</blockquote><br/>Ultimo passo, mettere insieme il tutto:<br/><blockquote>function LoadMarkersFromQuery (query) {<br/>var lista=GetSQLList(query);<br/>var array_lista = lista.split("\n");<br/>for (i in array_lista) {<br/>if (array_lista[i] != "") {<br/>AddMarkerFromAddress(array_lista[i], array_lista[i], array_lista[i]);<br/>}<br/>}<br/>}</blockquote><br/>Per caricare i marker quindi, bisognera' semplicemente (dopo aver creato la mappa con la funzione scritta in precedenza) richiamare la funzione LoadMarkersFromQuery passando come parametro il codice SQL necessario al reperimento dei dati degli indirizzi, es:<br/><blockquote>LoadMarkersFromQuery('select via, numero, cap, comune, stato from indirizzi');</blockquote><br/><a href="http://andreafortuna.files.wordpress.com/2006/07/maps.gif" class="imagelink" title="maps.gif"><img src="http://andreafortuna.files.wordpress.com/2006/07/maps.gif" alt="maps.gif" height="252" width="418" /></a>