---
layout: post
title: 'ASP.NET: realizzare lo screenshot di una pagina web'
date: '2008-01-11T13:00:00.001+01:00'
author: Andrea Fortuna
tags:
- VB.NET
- Programmazione
- ASP.NET
- C#
- website Thumbnail
modified_time: '2012-04-26T14:21:01.549+02:00'
blogger_id: tag:blogger.com,1999:blog-1948348952555789070.post-7146106290862162697
blogger_orig_url: http://oldsite.andreafortuna.org/2008/01/aspnet-realizzare-lo-screenshot-di-una_11.html
---

Scenario: web application in Asp.NET per la gestione e pubblicazione di un piccolo magazine informativo ad uso interno.<br/><br/>Oltre al numero attuale, gli utenti possono accedere, da una apposita pagina di archivio, alle precedenti pubblicazioni.<br/>Perche' non realizzare qualcosa per creare in tempo reale uno screenshot del numero in archivio, ridurlo a piccolo thumbnail e affiancarlo alla descrizione del numero in elenco?<br/><br/>Di gia' fatto non ho trovato niente, a parte un controllo ActiveX 'commerciale' e sinceramente molto poco economico, quindi ho deciso di realizzare qualcosa partendo da zero.<br/><br/>L'idea e' questa: perche' non utilizzare un controllo di tipo WebBrowser per caricare la pagina della quale vogliamo realizzare lo screenshot e poi 'ritagliare' il contenuto, salvando il tutto in una immagine?<br/>Il tutto si puo' fare anche in maniera non 'visuale', impacchettando tutto in una bella classe che automatizza la procedura: in questo modo l'oggetto puo' essere usato indifferentemente in una web application o in una applicazione stand-alone.<br/><br/>Ho realizzato il tutto in C#: una volta impacchettato l'oggetto in una classlibrary ci  si ritrova tra le mani un bel file .DLL da includere nella propria applicazione.<br/><br/>Di seguito il sorgente<br/><br/>[sourcecode language='csharp']<br/>using System;<br/>using System.Drawing;<br/>using System.Windows.Forms;<br/>using System.Threading;<br/>using System.IO;<br/>using System.Reflection;<br/><br/>using WinHttp;<br/><br/>    public class WebSiteThumbnail<br/>    {<br/>        private string url = null;<br/>        private Bitmap bmp = null;<br/>        public Bitmap Image<br/>        {<br/>            get<br/>            {<br/>                return bmp;<br/>            }<br/>        }<br/>        private ManualResetEvent mre = new ManualResetEvent(false);<br/>        private int timeout = 5; // Da raffinare<br/>        private int thumbWidth;<br/>        private int thumbHeight;<br/>        private int width;<br/>        private int height;<br/><br/>        #region Metodi Statici<br/>        public static Bitmap GetSiteThumbnail(string url, int width, int height, int thumbWidth, int thumbHeight)<br/>        {<br/>            WebSiteThumbnail thumb = new WebSiteThumbnail(url, width, height, thumbWidth, thumbHeight);<br/>            Bitmap b = thumb.GetScreenShot();<br/>            if (b == null)<br/>                b = (Bitmap)System.Drawing.Image.FromStream(Assembly.GetExecutingAssembly().GetManifestResourceStream("PAB.WebControls.Notavailable.jpg"));<br/>            return b;<br/>        }      <br/><br/>        #endregion<br/><br/>        #region Constructors<br/>        public WebSiteThumbnail(string url, int width, int height, int thumbWidth, int thumbHeight)<br/>        {<br/>            this.url = url;<br/>            this.width = width;<br/>            this.height = height;<br/>            this.thumbHeight = thumbHeight;<br/>            this.thumbWidth = thumbWidth;<br/>        }<br/>        #endregion<br/><br/>        #region ScreenShot<br/>        public Bitmap GetScreenShot()<br/>        {<br/>            Thread t = new Thread(new ThreadStart(_GetScreenShot));<br/>            t.SetApartmentState(ApartmentState.STA);<br/>            t.Start();<br/>            mre.WaitOne();<br/>            t.Abort();<br/>            return bmp;<br/>        }<br/>        #endregion<br/>        private void _GetScreenShot()<br/>        {<br/>            WebBrowser webBrowser = new WebBrowser();<br/>            webBrowser.ScrollBarsEnabled = false;<br/>            DateTime time = DateTime.Now;<br/><br/>            webBrowser.Navigate(url);<br/><br/>            webBrowser.DocumentCompleted += new WebBrowserDocumentCompletedEventHandler(WebBrowser_DocumentCompleted);<br/>            while (true)<br/>            {<br/>                Thread.Sleep(0);<br/>                TimeSpan elapsedTime = DateTime.Now - time;<br/>                if (elapsedTime.Seconds >= timeout)<br/>                {<br/>                    mre.Set();<br/>                }<br/>                Application.DoEvents();<br/>            }<br/><br/>        }<br/>        private void WebBrowser_DocumentCompleted(object sender, WebBrowserDocumentCompletedEventArgs e)<br/>        {<br/>            WebBrowser webBrowser = (WebBrowser)sender;<br/>            webBrowser.ClientSize = new Size(this.width, this.height);<br/>            webBrowser.ScrollBarsEnabled = false;<br/>            bmp = new Bitmap(webBrowser.Bounds.Width, webBrowser.Bounds.Height);<br/>            webBrowser.BringToFront();<br/>            webBrowser.DrawToBitmap(bmp, webBrowser.Bounds);<br/>            Image img = bmp.GetThumbnailImage(thumbWidth, thumbHeight, null, IntPtr.Zero);<br/>            bmp = (Bitmap)img;<br/>            webBrowser.Dispose();<br/>            if (mre != null)<br/>                mre.Set();<br/>        }<br/><br/>        public void Dispose()<br/>        {<br/>            if (bmp != null) this.bmp.Dispose();<br/>        }<br/>    }[/sourcecode]<br/>Veniamo a un esempio di utilizzo: una pagina .aspx che accetta come parametro l'url della pagina e restituisce uno stream con l'immagine della pagina.Realizzate quindi una nuova classlibrary, copiate il codice in GetSiteThumbnail.cs e compilate il tutto.Copiate poi la DLL generata nella directory 'bin' di un nuovo progetto web e realizzate un pagina chiamata (ad esempio) getsitethumb.aspx:<br/>[sourcecode language="vb"]<br/>< %@ Import Namespace="System.Drawing" %><br/>< %@ Import Namespace="System" %><br/>< %@ Import Namespace="System.Web" %><br/>< %@ Import Namespace="WebSiteThumbnail" %><br/><br/>< %@ Page MaintainScrollPositionOnPostback="false" %><br/><html><br/><script language="VB" runat="server"><br/><br/>  Sub Page_Load(Sender As Object, E As EventArgs)<br/>        Dim immagine As System.Drawing.Bitmap<br/>        If Request.QueryString("url" ) = "" Then Response.End()<br/>        Dim thumb As New WebSiteThumbnail(Request.QueryString("url"), 715, 715, 100, 100)<br/>        immagine = thumb.GetScreenShot()<br/>        Response.ContentType = "image/jpeg"<br/>        immagine.Save(Response.OutputStream, Imaging.ImageFormat.Jpeg)<br/>        Response.End()<br/>    End Sub<br/></script><br/></html>[/sourcecode]<br/>A questo punto, richiamando http://sito/getsitethumb.aspx?url=http://www.google.it visualizzerete sul browser un thumbnail di 1000x100px contenente una sezione di 715x715px dell'homepage di google.L'utilizzo all'interno di una normale pagina web e' quindi il seguente:<br/><br/>&lt;img src="http://sito/getsitethumb.aspx?url=http://www.google.it"&gt;