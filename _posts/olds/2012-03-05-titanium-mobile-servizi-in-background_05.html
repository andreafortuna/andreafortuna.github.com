---
layout: post
title: 'Titanium Mobile: servizi in background su Android'
date: '2012-03-05T10:35:00.001+01:00'
author: Andrea Fortuna
tags:
- Appcelerator
- Titanium Mobile
- Programmazione
- Service
- Android
modified_time: '2013-04-22T15:58:54.469+02:00'
blogger_id: tag:blogger.com,1999:blog-1948348952555789070.post-9698063729590919
blogger_orig_url: http://oldsite.andreafortuna.org/2012/03/titanium-mobile-servizi-in-background_05.html
---

Rispetto a <strong><a href="http://andreafortuna.org/tag/phonegap/">PhoneGap</a></strong>, <strong><a href="http://andreafortuna.org/tag/titanium-mobile/">Titanium Mobile</a></strong> ci permette di accedere a funzionalità specifiche del sistema su cui andiamo a sviluppare.<br />Ad esempio, su <strong><a href="http://andreafortuna.org/tag/android/">Android</a></strong>, possiamo realizzare semplici servizi in background che sopravvivono alla chiusura dell'app, ottimi per gestire le notifiche.<br /><br />Per prima cosa, è necessario creare un file .js (Es. <strong>UpdateService.js</strong>), contenente il codice che il nostro servizio andrà ad eseguire a intervalli regolari, ad esempio la presenza di un nuovo elemento in un feed RSS. Se l'elemento è stato trovato, invieremo anche una notifica sulla barra e salveremo l'ultimo elemento per le successive verifiche:<br /><br /><pre class="brush: java"><br /><br />//Verifico presenza di nuova notifica<br /><br />var loader = Titanium.Network.createHTTPClient();<br /><br />loader.open("GET",[URL DEL FEED]);<br /><br /><br /><br />loader.onload = function()<br /><br />{<br /><br />var xml = Ti.XML.parseString(this.responseText);<br /><br />var items = xml.documentElement.getElementsByTagName("item");<br /><br />Push = items.item(0).getElementsByTagName("title").item(0).text;<br /><br />var LastPush = Titanium.App.Properties.getString("LastPush");<br /><br />if (LastPush != Push) {<br /><br />sendNotify(SiteName,"Nuovo Articolo:" + Push,SiteName + ", nuovo articolo!");<br /><br />//Aggiorno LastPush<br /><br />Titanium.App.Properties.setString("LastPush",Push);<br /><br />}<br /><br />}<br /><br />loader.send();<br /><br /><br /><br />function sendNotify(titolo,testo, ticker) {<br /><br />//Creo notifica<br /><br />var activity = Ti.Android.currentActivity();<br /><br />var intent = Ti.Android.createIntent({<br /><br />action : Ti.Android.ACTION_MAIN,<br /><br />url : 'app.js',<br /><br />flags : Ti.Android.FLAG_ACTIVITY_NEW_TASK | Ti.Android.FLAG_ACTIVITY_SINGLE_TOP<br /><br />});<br /><br />intent.addCategory(Titanium.Android.CATEGORY_LAUNCHER);<br /><br />var pending = Ti.Android.createPendingIntent({<br /><br />intent : intent,<br /><br />type : Ti.Android.PENDING_INTENT_FOR_ACTIVITY,<br /><br />flags : Ti.Android.FLAG_ACTIVITY_NO_HISTORY<br /><br />});<br /><br /><br /><br />var notification = Ti.Android.createNotification({<br /><br />contentIntent : pending,<br /><br />contentTitle : titolo,<br /><br />contentText : testo,<br /><br />tickerText : ticker,<br /><br />when : new Date().getTime(),<br /><br />icon : Ti.App.Android.R.drawable.appicon,<br /><br />flags : Titanium.Android.ACTION_DEFAULT | Titanium.Android.FLAG_AUTO_CANCEL | Titanium.Android.FLAG_SHOW_LIGHTS<br /><br />});<br /><br />Ti.Android.NotificationManager.notify(1, notification);<br /><br />}<br /><br /></pre><br /><br />La funzione <em>sendNotify</em> può essere riutilizzata in molti contesti, permette di inviare in maniera agevole informazioni sulla barra delle notifiche: l'icona utilizzata sarà quella di default della applicazione, mentre l'action da effettuare quando viene eseguito il tap sulla notifica è definita con la proprietà <em>url</em> dell'intent (nel nostro caso viene caricata <strong>app.js</strong>, la finestra principale dell'app).<br /><br />Una volta definite le&nbsp;istruzioni che dovrà eseguire, è necessario creare il servizio e avviarlo con questo frammento di codice:<br /><br /><pre class="brush: java"><br /><br />var SECONDS = 600;<br /><br />var intent = Titanium.Android.createServiceIntent({<br /><br />url: 'UpdateService.js'<br /><br />});<br /><br />intent.putExtra('interval', SECONDS * 1000);<br /><br />Titanium.Android.startService(intent);<br /><br /></pre><br /><br />la proprietà <em>interval</em> dell'intent definisce l'intervallo in millisecondi (600000, 10 minuti) che dovrà intercorrere tra un'esecuzione e l'altra del codice presente in <strong>UpdateService.js</strong>.<br /><br /><img alt="" class="size-full wp-image-1564 alignright" height="136" src="http://andreafortuna.files.wordpress.com/2012/02/notifiche1.png" style="font-size: 16px; line-height: 18px;" title="Notifiche1" width="200" /><img alt="" class="size-full wp-image-1565 alignright" height="172" src="http://andreafortuna.files.wordpress.com/2012/02/notifiche2.png" title="notifiche2" width="276" /><br /><br />Il codice in questione può essere richiamato all'avvio dell'app: quando poi l'applicazione viene messa in secondo piano, il servizio rimane in esecuzione e nel caso rilevi un cambiamento invia una notifica sulla barra.<br /><br />Come ultima cosa, bisogna registrare nel manifest dell'applicazione il servizio, inserendo nel<strong> tiapp.xml</strong> del progetto queste righe:<br /><br /><pre class="brush: xml"><br /><br />&lt;android xmlns:android="http://schemas.android.com/apk/res/android"&gt;<br /><br />&nbsp; &nbsp; &lt;services&gt;<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;service url="UpdateService.js" type="interval"/&gt;<br /><br />&nbsp; &nbsp; &lt;/services&gt;<br /><br />&lt;/android&gt;<br /><br /></pre><br /><br />Per chi fosse curioso, l'applicazione negli screenshots è <a href="https://market.android.com/details?id=eu.eosarte.android" target="_blank">QUESTA</a>