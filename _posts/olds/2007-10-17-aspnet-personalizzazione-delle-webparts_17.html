---
layout: post
title: 'Asp.net: personalizzazione delle webparts a livello di pagina'
date: '2007-10-17T19:58:00.001+02:00'
author: Andrea Fortuna
tags:
- Programming
modified_time: '2012-04-26T14:21:39.200+02:00'
blogger_id: tag:blogger.com,1999:blog-1948348952555789070.post-8587077283909285150
blogger_orig_url: http://oldsite.andreafortuna.org/2007/10/aspnet-personalizzazione-delle-webparts_17.html
---

Grande cosa le webparts in Asp.net 2.0: la possibilita' di offrire interfacce personalizzabili agli utenti, con la possibilita' per ognuno di salvare le proprie impostazioni e' una gran bella cosa.<br/><br/>Tuttavia ci si puo' trovare in una situazione simile alla mia:<br/><br/>piccolo portale realizzato con le webpart, con lo storage delle personalizzazioni su un <em>Ms SQLServer 2000</em>; l'idea e' quella di permettere la personalizzazione delle pagine tramite le webparts, ma tali dati devono essere legati non all'utente che le realizza, ma alla singola pagina.<br/><br/>Di default la classe <em>SQLPersonalizationProvider</em> prevede personalizzazioni legate esclusivamente all'utente che le realizza, come fare a fare in modo che vengano salvate usando come discriminante l'indirizzo della pagina?<br/>Semplice, 'illudendo' il personalization provider che il nome della pagina sia lo username!<br/><br/>Tralasciando la realizzazione di una pagina funzionante con le webparts (si trovano in rete decine di tutorials,e cmq si presume che chi legga questo articolo quel passo lo abbia gia' superato) passiamo alla realizzazione di una classe custom derivata da <em>SQLPersonalizationProvider</em>:<br/><br/>[sourcecode language='vb']<br/><br/>Imports Microsoft.VisualBasic<br/><br/>Public Class CustomSqlPersonalizationProvider<br/>Inherits SqlPersonalizationProvider<br/><br/>Protected Overrides Sub LoadPersonalizationBlobs(ByVal _webPartManager As WebPartManager, ByVal _path As String, ByVal _userName As String, ByRef _sharedDataBlob() As Byte, ByRef _userDataBlob() As Byte)<br/>Dim pagina As String<br/>pagina = HttpContext.Current.Request.QueryString("page")<br/>MyBase.LoadPersonalizationBlobs(_webPartManager, _path, pagina, _sharedDataBlob, _userDataBlob)<br/>End Sub<br/><br/>Protected Overrides Sub ResetPersonalizationBlob(ByVal _webPartManager As WebPartManager, ByVal _path As String, ByVal _userName As String)<br/>Dim pagina As String<br/>pagina = HttpContext.Current.Request.QueryString("page")<br/>MyBase.ResetPersonalizationBlob(_webPartManager, _path, pagina)<br/>End Sub<br/><br/>Protected Overrides Sub SavePersonalizationBlob(ByVal _webPartManager As WebPartManager, ByVal _path As String, ByVal _userName As String, ByVal _dataBlob() As Byte)<br/>Dim pagina As String<br/>pagina = HttpContext.Current.Request.QueryString("page")<br/>MyBase.SavePersonalizationBlob(_webPartManager, _path, pagina, _dataBlob)<br/>End Sub<br/><br/>End Class<br/>[/sourcecode]<br/><br/>Di cosa si tratta? La nuova classe ereditata da <em>SQLPersonalizationProvider</em> esegue l'override dei metodi dedicati al salvataggio, caricamento e reset delle impostazioni e li altera in modo da utilizzare come identificativo per i dati salvati sul DB il valore del parametro 'page' passato in querystring anziche lo username dell'utente collegato.<br/><br/>A questo punto, dobbiamo modificare il web.config in modo da far utilizzare questa nuova classe al posto della tradizionale:<br/><br/>[sourcecode language='xml']<br/><webparts><br/><personalization defaultProvider="CustomSqlPersonalizationProvider"><br/><providers><br/><add name="CustomSqlPersonalizationProvider"<br/>type="CustomSqlPersonalizationProvider"<br/>connectionStringName="SQLConnString"<br/>applicationName="/" /><br/><br/></providers><br/><br/><authorization><br/><deny users="*" verbs="enterSharedScope" /><br/><allow users="*" verbs="modifyState" /><br/></authorization><br/></personalization><br/></webparts><br/><br/>[/sourcecode]<br/><br/>Passando quindi alla nostra pagina il parametro 'page' dalla querystring potremo differenziare le personalizzazioni:<br/><br/>le modifiche effettuate su http://sito/default.aspx?page=pagina1 saranno quindi separate e distinte da quelle su  http://sito/default.aspx?page=pagina2 e cosi' via.<br/><br/>interessante notare che con questo metodo la creazione della nuova pagina avviene come su un wiki: cercando infatti di accedere a una pagina attualmente non presente viene presentata una pagina con le webpartzones vuote, pronte per essere 'riempite'.