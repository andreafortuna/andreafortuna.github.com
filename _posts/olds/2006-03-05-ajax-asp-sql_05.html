---
layout: post
title: AJAX + ASP + SQL
date: '2006-03-05T18:28:00.001+01:00'
author: Andrea Fortuna
tags:
- JavaScript

modified_time: '2012-04-26T14:23:57.505+02:00'
blogger_id: tag:blogger.com,1999:blog-1948348952555789070.post-2098879805393333249
blogger_orig_url: http://oldsite.andreafortuna.org/2006/03/ajax-asp-sql_05.html
---

<p>I miei continui esperimenti con AJAX portano continuamente alla nascita di nuove 'follie'.</p><p>L'ultima riguarda una inconsueta mescolanza tra Javascript, ASP ed SQL.</p><p>Lo scenario e' questo: in un progetto ASP+MSSQL&nbsp;ho necessita' di creare dinamicamente con Javascript svariati elementi (in particolare tabelle e combobox), popolandoli con dei dati presenti sul&nbsp;database.<br />Il dover creare continuamente nuove pagine ASP per estrapolare i dati, e altre per salvarli mi rallenta di molto il lavoro.</p><p>A questo punto l'idea: perche' non realizzare una pagina ASP 'generica', alla quale passare semplicemente la query da eseguire, farmi restituire esclusivamente i dati e processarli con Javascript?</p><a name='more'></a><p>La struttura partorita dalla mia mente malata e' quindi cosi' costituita:</p><ol><li>Una pagina ASP, che accettera' in ingresso (anche con una semplice chiamata GET) una query, la eseguira' sul database e restituira' i dati sotto forma di XML.</li><li>Una classe Javascript che si occupera' di prelevare l'XML, processarlo ed estrarre i dati</li><li>I dati cosi' ottenuti verranno poi utilizzati da altre funzioni in Js che si occuperanno di creare gli elementi della pagina (Tabelle, ComboBox ecc..).</li></ol><p>Partiamo quindi dal codice ServerSide:</p><p><strong><em>SQL2XML.ASP</em></strong></p><blockquote><p>&lt;%<br />set con = Server.CreateObject (&quot;ADODB.connection&quot;)<br />Con.Open Application(&quot;Connessione_al_DataBase&quot;)</p><p>sql = request(&quot;query&quot;)<br />set rs = con.Execute(sql)</p><p><br />Dim oDOM<br />Set oDOM = Server.CreateObject(&quot;MSXML2.DOMDocument&quot;)<br />oDOM.async = False<br />rs.Save oDOM, 1 'adPersistXML</p><p>&nbsp;</p><p>Dim oXSL<br />Set oXSL = Server.CreateObject(&quot;MSXML2.DOMDocument&quot;)<br />oXSL.async = False<br />oXSL.load Server.MapPath(&quot;ADOGeneric.xsl&quot;)<br />Response.Write &quot;&lt;XML id='xmlData' name='xmlData'&gt;&lt;root&gt;&quot; &amp; vbCrLf<br />Response.Write oDOM.transformNode(oXSL)<br />Response.Write &quot;&lt;/root&gt;&lt;/XML&gt;&quot;</p><p>%&gt;</p></blockquote><p>Il funzionamento e' semplice: estrae la query da eseguire dalla QueryString, effettua la connessione al DataBase, raccoglie i dati, li converte in XML e li formatta utilizzando lo StyleSheet XML <em>ADOGeneric.xsl</em>.</p><p><em><strong>ADOGeneric.xsl</strong></em></p><blockquote><p>&lt;?xml version='1.0'?&gt;<br />&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;<a href="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</a>&quot; xmlns:s=&quot;uuid:BDC6E3F0-6DA3-11d1-A2A3-00AA00C14882&quot; xmlns:z=&quot;#RowsetSchema&quot;&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;s:Schema id=&quot;RowsetSchema&quot;/&gt;<br />&lt;xsl:output method=&quot;xml&quot; omit-xml-declaration=&quot;yes&quot; /&gt;<br />&lt;xsl:template match=&quot;/&quot;&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xsl:apply-templates select=&quot;//z:row&quot;/&gt;<br />&lt;/xsl:template&gt;</p><p>&lt;xsl:template match=&quot;z:row&quot;&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xsl:text disable-output-escaping=&quot;yes&quot;&gt;&amp;lt;row&amp;gt;&lt;/xsl:text&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xsl:for-each select=&quot;@*&quot;&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xsl:text disable-output-escaping=&quot;yes&quot;&gt;&amp;lt;&lt;/xsl:text&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xsl:value-of select=&quot;name()&quot;/&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xsl:text disable-output-escaping=&quot;yes&quot;&gt;&amp;gt;&lt;/xsl:text&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xsl:value-of select=&quot;.&quot;/&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xsl:text disable-output-escaping=&quot;yes&quot;&gt;&amp;lt;/&lt;/xsl:text&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xsl:value-of select=&quot;name()&quot;/&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xsl:text disable-output-escaping=&quot;yes&quot;&gt;&amp;gt;&lt;/xsl:text&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/xsl:for-each&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xsl:text disable-output-escaping=&quot;yes&quot;&gt;&amp;lt;/row&amp;gt;&lt;/xsl:text&gt;<br />&lt;/xsl:template&gt;<br />&lt;/xsl:stylesheet&gt;</p></blockquote><p>La riformattazione utilizzando lo stylesheet rende piu' comodo il successivo processo di interpretazione dei dati tramite Javascript.</p><p>Mettiamo ora mano al codice ClientSide:</p><p><strong><em>Query2Table.js</em></strong></p><blockquote><p>/*<br />* Creazione tabella da query<br />* @param&nbsp;&nbsp;&nbsp; Query&nbsp;&nbsp;&nbsp; Stringa contenente la query da inviare al server<br />* @param&nbsp;&nbsp;&nbsp; elemento&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ID dell'elemento della pagina che conterr&agrave; la tabella<br />*/</p><p>function SQL2Table(query, elemento)<br />{<br />&nbsp;<br />&nbsp;if (document.implementation &amp;&amp; document.implementation.createDocument)<br />&nbsp;{<br />&nbsp;&nbsp;xmlDoc = document.implementation.createDocument(&quot;&quot;, &quot;&quot;, null);<br />&nbsp;&nbsp;xmlDoc.onload = createTable(elemento);<br />&nbsp;}<br />&nbsp;else if (window.ActiveXObject)<br />&nbsp;{<br />&nbsp;&nbsp;xmlDoc = new ActiveXObject(&quot;Microsoft.XMLDOM&quot;);<br />&nbsp;&nbsp;xmlDoc.onreadystatechange = function () {<br />&nbsp;&nbsp;&nbsp;if (xmlDoc.readyState == 4) createTable(elemento)<br />&nbsp;&nbsp;};<br />&nbsp;&nbsp;}<br />&nbsp;else<br />&nbsp;{<br />&nbsp;&nbsp;alert('Your browser can\'t handle this script');<br />&nbsp;&nbsp;return;<br />&nbsp;}<br />&nbsp;query = query.replace(&quot; &quot;,&quot;+&quot;);<br />&nbsp;xmlDoc.load(&quot;SQL2XML.asp?query=&quot; + query);<br />}</p><p>function createTable(oggetto)<br />{<br />&nbsp;var x = xmlDoc.getElementsByTagName('row');<br />&nbsp;var newEl = document.createElement('TABLE');<br />&nbsp;newEl.setAttribute('cellPadding',5);<br />&nbsp;var tmp = document.createElement('TBODY');<br />&nbsp;newEl.appendChild(tmp);<br />&nbsp;var row = document.createElement('TR');<br />&nbsp;for (j=0;j&lt;x[0].childNodes.length;j++)<br />&nbsp;{<br />&nbsp;&nbsp;if (x[0].childNodes[j].nodeType != 1) continue;<br />&nbsp;&nbsp;var container = document.createElement('TH');<br />&nbsp;&nbsp;var theData = document.createTextNode(x[0].childNodes[j].nodeName);<br />&nbsp;&nbsp;container.appendChild(theData);<br />&nbsp;&nbsp;row.appendChild(container);<br />&nbsp;}<br />&nbsp;tmp.appendChild(row);<br />&nbsp;for (i=0;i&lt;x.length;i++)<br />&nbsp;{<br />&nbsp;&nbsp;var row = document.createElement('TR');<br />&nbsp;&nbsp;for (j=0;j&lt;x[i].childNodes.length;j++)<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;if (x[i].childNodes[j].nodeType != 1) continue;<br />&nbsp;&nbsp;&nbsp;var container = document.createElement('TD');<br />&nbsp;&nbsp;&nbsp;var theData = document.createTextNode(x[i].childNodes[j].firstChild.nodeValue);<br />&nbsp;&nbsp;&nbsp;container.appendChild(theData);<br />&nbsp;&nbsp;&nbsp;row.appendChild(container);<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;tmp.appendChild(row);<br />&nbsp;}&nbsp;<br />&nbsp;<br />&nbsp;document.getElementById(oggetto).appendChild(newEl);<br />}</p></blockquote><p>La funzione <em>SQL2Table</em> si occupa, con il solito meccanismo <em>cross browser</em> di richiamare la pagina ASP creata in precedenza passandogli la query da eseguire, estraendo i dati e passandoli alla seconda funzione (<em>createTable</em>) insieme all'ID dell'elemento della pagina che conterra' la tabella (un &lt;p&gt; o un &lt;div&gt;).</p><p><em>createTable </em>processera' l'XML ottenuto da <em>SQL2Table</em>, creando&nbsp; la tabella con nella prima riga le intestazioni contenenti i nomi dei campi estratti dalla query, 'riversando' poi il tutto nell'elemento della pagina specificato.</p><p>Volendo testare il corretto funzionamento del nostro script, possiamo realizzare un semplice&nbsp;documento HTML:</p><p><strong><em>Test.htm</em></strong></p><blockquote><p>&lt;SCRIPT LANGUAGE=javascript src=&quot;Query2Table.js&quot;&gt;&lt;/SCRIPT&gt;</p><p>&lt;p id=tabella name=tabella&gt;&lt;/p&gt;</p><p>&lt;INPUT type=&quot;button&quot; value=&quot;Crea Tabella&quot; id=button1 name=button1 onclick=&quot;javascript:SQL2Table('select * from impiegati','tabella');&quot;&gt;</p></blockquote><p>Come si puo' evincere dal codice, tutto cio' comporta sicuramente una maggiore rapidita' nella fruizione di dati dal DB, ma include serie conseguenze dal lato della sicurezza:<br />premetto che questa che sto&nbsp;implementando questa struttura all'interno di un progetto destinato ad una intranet, quindi in mano a personale 'fidato' (lungi da me metter un accrocchio del genere su internet), ma nulla toglie che un utente malizioso e un po' piu' <em>skillato </em>possa fare il bello e il cattivo tempo sul database.</p><p>La soluzione da me qui riportata deve essere intesa solo come un <em>proof of concept</em>, niente quindi che possa essere utilizzando in un progetto reale, a meno che non si implementi (come sto gia' facendo)&nbsp;un meccanismo di comunicazione 'sicuro' tra client e server, magari criptando in qualche modo la stringa contenente la query da eseguire.</p>