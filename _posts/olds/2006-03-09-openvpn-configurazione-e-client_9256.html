---
layout: post
title: OpenVPN - Configurazione e Client ‘portatile’
date: '2006-03-09T09:19:00.002+01:00'
author: Andrea Fortuna
tags:
- Security
modified_time: '2012-04-26T14:23:57.527+02:00'
blogger_id: tag:blogger.com,1999:blog-1948348952555789070.post-3551507101879518679
blogger_orig_url: http://www.andreafortuna.org/2006/03/openvpn-configurazione-e-client_9256.html
---

<p>Ultimamente sto apprezzando molto le possibilita' offerte da <a href="http://openvpn.net/" target="_blank">OpenVPN</a>, un software per la realizzazione di reti private virtuali:</p><blockquote><p>OpenVPN is a full-featured SSL VPN solution which can accomodate a wide range of configurations, including remote access, site-to-site VPNs, WiFi security, and enterprise-scale remote access solutions with load balancing, failover, and fine-grained access-controls</p></blockquote><p>Lo sto usando con discreta soddisfazione per accedere da remoto alla mia rete casalinga: fino a poco tempo fa utilizzavo esclusivamente tunnels generati con SSH2, ma da quando ho provato l'ebrezza della VPN (:-D) non posso piu' farne a meno! :-)</p><a name='more'></a><p>La configurazione da me utilizzata &egrave; abbastanza semplice ma mi permette di dare accesso a un buon numero di client senza problemi: oltre a me, infatti, sono collegate tramite VPN alla mia rete anche macchine di amici/colleghi fidati, alcuni anche in join al mio dominio Active Directory 'casalingo'.</p><p>Partiamo dal server:</p><p><strong><em>Ubuntu GNU/Linux, kernel&nbsp; 2.6.12</em></strong> (fino a qualche giorno il server girava su un Windows 2000 Server: le modifiche ai file di configurazione per la migrazione sono state minime).</p><p>Naturalmente in primis bisogna effettuare l'installazione di OpenVPN, e per questo lascio tutte le liberta' possibili: tramite APT, scaricando i sorgenti dal sito o utilizzando pacchetti precompilati di ogni tipo.</p><p>Il primo passo per la configurazone consiste nella generazione delle chiavi pubbliche e private necessarie all'autenticazione.</p><p>Per questo compito usiamo i tool della 'suite' Easy-RSA, installata insieme al pacchetto di OpenVPN.</p><p>Usiamo quindi il tool <strong>build-ca</strong> per generare il <em>Certification Authority (CA) certificate </em>(ca.crt), <strong>build-dh</strong> per i parametri <em>Diffie-Hellmann</em>, e <strong>build-key</strong> per generare le chiavi pubbliche e private della nostra VPN (ca.key). Dico pubbliche e private perche' nel mio caso non punto alla sicurezza 'stagna', ma alla comodita' di collegare altre reti alla mia in maniera semplice, rapida e economica.<br />Quindi, invece di generare una chiave privata per il server e una serie di chiavi pubbliche corredate da certificati per i client (esclusive per ogni client), prediligo (orrore e schifo!) utilizzare la stessa chiave sia per server che per client: questo mi permette di aggiugere 'al volo' un nuovo client VPN alla mia rete. Della sicurezza mi occupo a livello superiore, dividendo la subnet dei client VPN dalla mia rete domestica con qualche regola di firewalling.</p><p>In quest'ottica 'insicura', il file di configurazion del server sara' il seguente</p><p>root@zapotec:~# cat /etc/openvpn/server.conf<br /></p><blockquote><p>dev tap&nbsp; #Utilizzo il dispositivo di rete virtuale TAP<br />proto tcp-server <br />ifconfig 10.0.0.1 255.255.255.0 #definisco l'IP del server all'interno della subnet dedicata alla VPN<br />tls-server </p><p># Percorsi dei certificati<br />key &quot;/etc/openvpn/certificati/ca.key&quot;<br />dh &quot;/etc/openvpn/certificati/dh.pem&quot;<br />cert &quot;/etc/openvpn/certificati/ca.crt&quot;<br />ca &quot;/etc/openvpn/certificati/ca.crt&quot;<br />local 192.168.0.2 #IP 'reale' del server VPN<br /><br />lport 8080 #porta di ascolto del server<br />verb 4 <br /><br />mode server<br />duplicate-cn<br /><br />ifconfig-pool 10.0.0.10 10.0.0.30 # Range di IP da assegnare ai clients<br />mssfix 1450<br />#Mantiene il tunnel aperto effettuando dei ping a intervalli regolari<br />push &quot;ping 10&quot;<br />push &quot;ping-restart 60&quot;<br />ping 10<br />ping-restart 120<br />#Invia le regole di routing ai clients<br />push &quot;192.168.0.0 255.255.255.0 10.0.0.1&quot; #routing verso la rete 'reale'<br />push &quot;dhcp-option DNS 192.168.0.3&quot;&nbsp; #invio al client l'indirizzo del DNS<br />comp-lzo #attiva la compressione<br /></p></blockquote><p>Naturalente&nbsp;i certificati prima generati&nbsp;saranno stati copiati nella cartella /etc/openvpn/certificati/.</p><p>Nell'esempio proposto, la rete 'reale' e' costituita da una subnet 192.168.0.0/24, con 192.168.0.1 assegnato al default gateway e 192.168.0.3 al server DNS.<br />Ai client VPN e' stata assegnata una subnet 'virtuale' 10.0.0.0/24, con default gateway su 10.0.0.1 (lo stesso server OpenVPN).</p><p>A livello di rete, per permettere ai client di accedere alla rete, sono necessari 2 passi:</p><ul><li><div>Attivare l'IP forwarding sulla macchina linux&nbsp;che ospita OpenVPN, con <em>echo 1 &gt; /proc/sys/net/ipv4/ip_forward</em></div></li><li><div>Aggiungere sul proprio router (quindi defaul gateway della rete 'reale') una route statica per la rete 10.0.0.0/24 verso l'ip del server VPN (in questo caso 192.168.0.2).</div></li></ul><p>Vediamo ora la (piu' semplice) configurazione del client:</p><blockquote><p>remote IP_DEL_SERVER<br />rport 8080<br />proto tcp-client<br />tls-client<br />dev tap<br />tls-client</p><p>key &quot;/etc/openvpn/certificati/ca.key&quot;<br />ca &quot;/etc/openvpn/certificati/ca.crt&quot;<br />cert &quot;/etc/openvpn/certificati/ca.crt&quot;</p><p>pull<br />route 192.168.0.0 255.255.255.0 10.0.0.1<br />comp-lzo<br />verb 4</p></blockquote><p>Come gia' detto sopra, la configurazione e' 'spiccia' ed insicura, utilizzando la stessa chiave per client e server, senza utilizzare il sistema di chiave pubblica e privata.</p><p>Addirittura, per facilitarmi ancora di piu' le operazioni di collegamento alla mia rete, ho realizzato un client OpenVPN per Windows 'portatile' da tenere su una normale chiave dati USB.</p><p>Questa la struttura delle directory:</p><p>G:\VPNCLIENT<br />│&nbsp;&nbsp; VPNSTART.bat<br />│&nbsp;&nbsp; VPNSTOP.bat<br />│<br />├───driver<br />│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OemWin2k.inf<br />│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tap0801.sys<br />│<br />├───config<br />│&nbsp;&nbsp; │&nbsp;&nbsp; client.ovpn<br />│&nbsp;&nbsp; │<br />│&nbsp;&nbsp; └───certificati<br />│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ca.crt<br />│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ca.key<br />│<br />└───bin<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ca.crt<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ca.key<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; deltapall.bat<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KILL.EXE<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; libeay32.dll<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; libssl32.dll<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; openssl.cnf<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; openssl.exe<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; openvpn.exe<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; openvpnserv.exe<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tapinstall.exe</p><p>Nella cartella <strong><em>bin</em></strong> sono presenti eseguibili e DLL&nbsp;necessari al funzionamento di OpenVPN, in <strong><em>config</em></strong> ho copiato la configurazione del client e i certificati e in <strong><em>driver</em></strong> il driver del dispositivo TAP indispensabile alla creazione della scheda di rete virtuale.</p><p>Le uniche modifiche da effettuare sono sulla configurazione del client, che deve essere adattata ai percorsi non assoluti:</p><blockquote><p>remote IP_DEL_SERVER<br />rport 8080<br />proto tcp-client<br />tls-client<br />dev tap<br />tls-client</p><p>key &quot;./config/certificati/ca.key<br />ca &quot;./config/certificati/ca.crt&quot;<br />cert &quot;./config/certificati/ca.crt&quot;</p><p>pull<br />route 192.168.0.0 255.255.255.0 10.0.0.1<br />comp-lzo<br />verb 4</p></blockquote><p>Ho creato inoltre 2 batch (VPNSTART.BAT e VPNSTOP.BAT) che si occupano di creare il dispositivo virtuale e avviare la VPN (VPNSTART) e di chiudere la VPN e rimuovere il dispositivo creato (VPNSTOP).</p><p><strong><em>VPNSTART.BAT</em></strong></p><blockquote><p>@Echo Off<br />&quot;bin\tapinstall.exe&quot; install &quot;driver\OemWin2k.inf&quot; tap0801<br />&quot;bin\openvpn.exe&quot; --config config\client.ovpn</p></blockquote><p><strong><em>VPNSTOP.BAT</em></strong></p><blockquote><p>@Echo Off<br />bin\kill.exe openvpn.exe<br />&quot;bin\tapinstall.exe&quot; remove tap0801<br />pause</p></blockquote><p>In questo modo e' possibile sedersi a un PC, inserire la chiavetta e collegarsi alla propria VPN, lasciando una volta finito di lavorare il PC ospite 'pulito'.</p><p>Non smetto di ripetere che anche questo utilizzo di OpenVPN e' estremamente 'insicuro':</p><p>porto in giro i miei certificati... (<em>il bravo sistemista&nbsp;comincia storcere il muso</em>)</p><p>...compresa la chiave privata... (<em>il bravo sistemista cambia colore</em>)</p><p>...su una chiave dati USB, facilmente smarribile...(a<em>l bravo sistemista comincia a mancare l'aria</em>)</p><p>...copio il tutto agli amici che vogliono avere un accesso alla mia rete...(<em>il bravo sistemista ha un mancamento</em>)</p><p>...magari per fare una partita in rete a Quake3...(<em>il bravo sistemista sembra riprendersi</em>)</p><p>...e se serve, gli spedisco tutto via E-Mail! (<em>il bravo sistemista ha un arresto cardiaco</em>)</p><p>:-D</p>