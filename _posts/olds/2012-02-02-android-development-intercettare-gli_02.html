---
layout: post
title: 'Android Development: intercettare gli sms ricevuti'
date: '2012-02-02T15:04:00.001+01:00'
author: Andrea Fortuna
tags:
- Java
- Programmazione
- SMS
- programming
- Android
- Telefonia
modified_time: '2013-04-22T15:55:48.454+02:00'
blogger_id: tag:blogger.com,1999:blog-1948348952555789070.post-1393006074624814338
blogger_orig_url: http://oldsite.andreafortuna.org/2012/02/android-development-intercettare-gli_02.html
---

<img alt="" class="alignleft size-medium wp-image-1386" height="194" src="http://andreafortuna.files.wordpress.com/2012/02/android-sms-smaller.png?w=300" title="Android-SMS-smaller" width="300" />La struttura di Android è estremamente modulare: quasi tutti gli eventi vengono gestiti tramite messaggi di broadcast, che vengono letti dai programmi installati sul device.<br /><br />Ad esempio, alla ricezione di un SMS, viene scatenato un Intent con al suo interno la proprietà action valorizzata a <strong>android.provider.Telephony.SMS_RECEIVED</strong>: se &nbsp;sul sistema è presente un programma che può gestirlo, il gli sistema 'passa la palla' (e l'intent).<br /><br />Nel caso siano presenti più programmi abilitati a gestire l'intent, android li ordina per priorità e passa l'intent a tutti.<br /><br />Di recente ho sviluppato un piccolo tool per Android che ho chiamato <a href="https://market.android.com/details?id=com.andreafortuna.microspia">Microspia</a>: in pratica permette di controllare tramite SMS il telefono sul quale viene installato e, alla ricezione di messaggi contenenti comandi da lui riconosciuti, fa in modo che quell'SMS non venga visualizzato nell'applicazione di gestione messaggi del terminale.<br /><br />Vediamo come ho fatto...<br /><a name='more'></a><br /><br />Per prima cosa, è necessario aggiungere al file AndroidManifest.xml nel nostro progetto la definizione dell'Intent Filter, che elegge la nostra applicazione ad essere 'messa in coda' per gestire un determinato intent:<br /><br /><pre class="brush: xml"><br /><br /><br /><br />&lt;receiver android:name=".SMSReader" &gt;<br /><br />&lt;intent-filter android:priority="10000" &gt;<br /><br />&lt;action android:name="android.provider.Telephony.SMS_RECEIVED" /&gt;<br /><br />&lt;/intent-filter&gt;<br /><br />&lt;/receiver&gt;<br /><br /><br /><br /></pre><br /><br />e aggiungiamo le corrette permissions:<br /><br /><pre class="brush: xml"><br /><br /><br />&lt;uses-permission android:name="android.permission.RECEIVE_SMS" &gt;<br /><br /><br /><br /></pre><br /><br />Definiamo quindi che la classe <em><strong>SMSReader</strong></em> si occuperà di gestire l'intent con action <strong>android.provider.Telephony.SMS_RECEIVED</strong>, ed avrà priorità <strong>10000</strong>.<br />Specificando il valore priority, andiamo a dire al sistema quale sarà (appunto) la priorità di questo receiver rispetto ad altri (a valore più alto corrisponde priorità maggiore).<br />Con un valore <strong>10000</strong> avremo la sostanziale sicurezza che il nostro software sia il primo a ricevere l'intent.<br /><br />Ora dobbiamo definire la classe <em><strong>SMSReader</strong></em>:<br /><br /><pre class="brush: java"><br />public class SMSReader extends BroadcastReceiver {<br /><br />@Override<br /><br />public void onReceive(final Context context, Intent intent) {<br /><br /><br /><br />Bundle bundle = intent.getExtras();<br /><br /><br /><br />Object messages[] = (Object[]) bundle.get("pdus");<br /><br /><br /><br />SmsMessage smsMessage[] = new SmsMessage[messages.length];<br /><br />for (int n = 0; n &lt; messages.length; n++) {<br /><br />smsMessage[n] = SmsMessage.createFromPdu((byte[]) messages[n]);<br /><br />}<br /><br /><br /><br />// Verifico testo messaggio<br /><br />if (smsMessage[0].getMessageBody().toString().equals([COMANDO DA INTERPRETARE])) {<br /><br />this.abortBroadcast();<br /><br /><br /><br />[CODICE DA ESEGUIRE]<br /><br />}<br /><br />}<br /><br />}<br /><br /><br /><br /></pre><br /><br />La nostra classe estende la classe base <strong>BroadcastReceiver</strong> (abilitata alla ricezione degli Intent) ed espone il metodo <strong>onReceive</strong>.<br />In onReceive per prima cosa estraiamo i dati dall'intent utilizzando il metodo <strong>getExtras</strong>, poi dai dati ottenuti preleviamo i dati relativi al <strong>PDU</strong> (<em>"protocol discription unit"</em>, formato standard per gli SMS), contenenti i messaggi presenti nell'intent.<br />Poi cicliamo i messaggi e appoggiamo tutto all'interno di un array di oggetti <strong><em>android.telephony.SmsMessage</em></strong> (smsMessage).<br /><br />Successivamente diamo per scontato che all'interno dell'intent sia presente un solo messaggio e andiamo a interpretarne il testo pescandolo tramite il metodo <strong>getMessageBody</strong> sull'elemento zero dell'array.<br /><br />Se all'interno del testo del messaggio è presente un comando da eseguire, facciamo in modo che l'SMS non sia recapitato al software di messaggistica presente nel telefono.<br />Per farlo invochiamo il metodo<strong> abortBroadcast()</strong> che 'ferma' la propagazione dell'intent ad altri programmi presenti nel terminale.<br />Nei prossimi articoli vedremo come leggere altri dati presenti nell'SMS e come inviare messaggi dalla nostra applicazione.