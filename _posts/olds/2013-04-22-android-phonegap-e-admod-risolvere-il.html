---
layout: post
title: 'Android, Phonegap e AdMod: risolvere il problema dello svuotamento del localStorage
  di HTML5'
date: '2013-04-22T13:06:00.000+02:00'
author: Andrea Fortuna
tags:
- Java
- localstorage
- html5
- Android
- phonegap
- admob
modified_time: '2013-04-22T16:39:22.609+02:00'
thumbnail: http://2.bp.blogspot.com/-NFWEynPzvTs/UXUZBKMPlbI/AAAAAAAAEhs/7Z2q42k2hTI/s72-c/brand.gif
blogger_id: tag:blogger.com,1999:blog-1948348952555789070.post-8470133108678475674
blogger_orig_url: http://oldsite.andreafortuna.org/2013/04/android-phonegap-e-admod-risolvere-il.html
---

<div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-NFWEynPzvTs/UXUZBKMPlbI/AAAAAAAAEhs/7Z2q42k2hTI/s1600/brand.gif" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://2.bp.blogspot.com/-NFWEynPzvTs/UXUZBKMPlbI/AAAAAAAAEhs/7Z2q42k2hTI/s1600/brand.gif" /></a></div>Bug fastidioso, quello del modulo <a href="http://www.admob.com/" target="_blank">AdMob </a>per Android: se integrato in una applicazione <a href="http://oldsite.andreafortuna.org/search/label/phonegap" target="_blank">PhoneGap</a>, tende ad ogni avvio a svuotare i dati salvati nel localStorage, quella funzionalità di HTML5 che io definisco (impropriamente) "cookies agli steroidi".<br /><br />Sviluppando con <b>PhoneGap </b>il localStorage viene spesso utilizzato proprio per salvare informazioni riguardanti la configurazione dell'app, e trovarselo vuoto ad ogni avvio della stessa può risultare quantomeno sconvenitente. ;-)<br /><br />Facendo alcune prove, ho verificato che il problema si manifesta solo quando il codice di <b>AdMob </b>viene richiamato prima che venga invocato l'evento '<i>onDeviceReady</i>' (solitamente al termine dell'inizializzazione del phonegap).<br /><br /><a name='more'></a><br /><br />Da qui la modifica è stata semplice: invece di creare il banner di admob subito dopo il caricamento dell'index.html:<br /><br /><br /><pre class="brush: java">package org.andreafortuna.admobdemo;<br /><br />import android.os.Bundle;<br />import android.os.Handler;<br /><br />import org.apache.cordova.*;<br />import android.widget.LinearLayout; <br />import com.google.ads.*;<br /><br />public class ADMOBDEMO extends DroidGap<br />{<br />    private static final String AdMob_Ad_Unit = "ADMOBID";<br />    private AdView adView; <br />    @Override<br />    public void onCreate(Bundle savedInstanceState)<br />    {<br />        super.onCreate(savedInstanceState);<br />        // Set by <content src="index.html"> in config.xml<br />        super.loadUrl(Config.getStartUrl());<br />        adView = new AdView(this, AdSize.SMART_BANNER, AdMob_Ad_Unit);<br />        LinearLayout layout = super.root;<br />        layout.addView(adView);<br />        layout.setHorizontalGravity(android.view.Gravity.CENTER_HORIZONTAL);<br />        AdRequest request = new AdRequest();<br />        adView.loadAd(request);                     <br />    }<br />}<br /></content></pre><br /><br />ho ritardato l'operazione di 15 secondi:<br /><br /><pre class="brush: java">package org.andreafortuna.admobdemo;<br /><br />import android.os.Bundle;<br />import android.os.Handler;<br /><br />import org.apache.cordova.*;<br />import android.widget.LinearLayout; <br />import com.google.ads.*;<br /><br />public class ADMOBDEMO extends DroidGap<br />{<br />    private static final String AdMob_Ad_Unit = "ADMOBID";<br />    private AdView adView; <br />    private Handler mHandler = new Handler();<br />    @Override<br />    public void onCreate(Bundle savedInstanceState)<br />    {<br />        super.onCreate(savedInstanceState);<br />        // Set by <content src="index.html"> in config.xml<br />        super.loadUrl(Config.getStartUrl());<br />        mHandler.postDelayed(new Runnable() {<br />            public void run() {<br />                doAdMob();<br />            }<br />        }, 15000);         <br />    }<br />    <br />    private void doAdMob() {<br />        adView = new AdView(this, AdSize.SMART_BANNER, AdMob_Ad_Unit);<br />        LinearLayout layout = super.root;<br />        layout.addView(adView);<br />        layout.setHorizontalGravity(android.view.Gravity.CENTER_HORIZONTAL);    <br />        AdRequest request = new AdRequest();        <br />        adView.loadAd(request);                    <br />    }<br />}<br /></content></pre><br />In questo modo il localStorage resta intatto.